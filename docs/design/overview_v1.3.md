# 業務用アプリ設計検討案（整理版 v1.3）

## 目的 / 非目的

- **目的**：店舗の来店客数（将来は売上も）、を、会社横断で「日次/月次」で集計・比較し、権限管理のもとで閲覧・管理できる基盤を作る。
- **非目的（当面）**：高度な可視化・UI最適化、複雑なワークフロー、DWH規模の横断分析。

## MVPスコープ（GUIなし・コア先行）

1. **DB同期の骨組み**（メインDB ⇄ クライアントDB、LSN方式、Push/Pullと差分適用）
2. **マスタ最小セット**（会社・店舗・国/ブランド/立地種別/ユーザ/権限）
3. **日次データ登録**（来店客数：予測・実績・前年系）
4. **按分エンジン**（月次予算 × 係数 → 日別配賦、月合計は不変）
5. **レポートの計算API**（C1〜C4に必要な集計を返すサービス層まで）

> GUIは後付け（第2段階）。まずは上位5点の**CLI/サービスAPI**を完成させる。

## 技術スタック（確定）

- 言語/ランタイム：Java
- ビルド：Maven
- ストレージ：SQLite（メインDB/クライアントDB）
- 将来GUI：JavaFX（第2段階）
- 開発：VS Code + GitHub workflows

------

## アーキテクチャ（層とモジュール）

- **domain**：エンティティ（Company, Store, VisitDaily, BudgetDaily, Factors…）/ 値オブジェクト / ドメインサービス（按分）
- **application**：ユースケース（Sync, Import/Export, ReportQuery, UserProvisioning）
- **infrastructure**：SQLiteリポジトリ、マイグレーション、接続・トランザクション、LSN/ChangeLog
- **interface（CLI first）**：コマンド（例：`sync pull`, `sync push`, `report c1 --yyyymm=202501 --company=JP`）

> 第2段階で **ui-javafx** モジュールを追加し、application 層のユースケースを呼び出す。

------

## データ設計（要旨）

### マスタ

- **Company**（会社）
- **Country / Brand / LocationType**（所在国・ブランド・立地種別）
- **Store**（会社FK・コード・名称・国・ブランド・立地・座席数・営業時間・ステータス・ブロック・エリア等）
- **User / Role / UserRole**（ログインと権限）
- **CodeMaster**（将来の汎用コード表）

### 取得・明細

- **VisitDaily**：店舗×日付の実績値（来店客数）
- **BudgetMonthly**：店舗×年月の月次予算
- **BudgetFactors**：店舗（または会社共通）×月の係数セット（按分用）
- **VisitDailyPrev**：前年同日/前年同週の参照値

### 同期・監視

- **change_log**：グローバルLSN、DML、対象テーブル、主キー、差分、tx_id、tombstone等
- **sync_state**：クライアントごとの最終適用LSN
- **id_map**：必要ならクライアント仮ID→メインID
- **sync_lock**：排他管理

> **BudgetDaily（派生）**は当面持たず、オンデマンド計算 or キャッシュで対応。

------

## 同期方式（LSN/ChangeLogの要点）

- **決定**：Main/Client ともに実テーブル＋change_log を保持（ログ専用メインは採用しない）。
- 変更は**各実テーブルのトリガ**で `change_log` に記録（I/U/D + tombstone）。
- **Push/Pull**は `sync_state.last_lsn` より新しい差分をバッチ適用。
- **競合**は基本は**メイン優先**。クライアントは push 前に pull で整合を確保。
- **主キー衝突**：PKは原則 `INTEGER`（ROWID）。マスタは業務キーUNIQUE（例：`store_code`）で同一判定・マージ。必要時のみ `id_map` を運用。
- **パフォーマンス**：バルク/ATTACH、適切なインデックス、PRAGMA 最適化。

------

## レポート（C1〜C4）実装方針（GUI前提の準備）

- **API化**：C1〜C4の集計クエリ/サービスを先に提供。GUIは後で呼ぶだけ。
- **前年同日/同週切替**：日付ディメンション（暦テーブル）か計算ロジックで吸収。
- **大規模表示**：ページング/仮想スクロール（C1/C4は特に注意）。
- **事前集計/マテビュー**は将来の運用オプション。

------

# これから決める＆検討すべき点（一覧）

## 1. データ・仕様

- **日付ディメンション**：持つ（祝日/暦週/会計月保守）か計算のみで行くか
- **前年度参照**：VisitDailyPrev の設計（計算 or 参照テーブル）
- **按分（合計固定）**：端数処理：最大剰余法（Hamilton法）を採用（明記）
- **会社共通係数と個別係数の優先度**：個別が優先
- **OPEN/CLOSE月**：月単位扱い（按分しない）
- **タイムゾーン/営業時間**：深夜0時切替（跨ぎ営業なし前提）
- **売上導入**：MVPから導入可能（来店客数と同一スキーマ）

## 2. 同期・オフライン

- **差分粒度**：行単位（将来、列差分へ展開可）
- **ATTACH**：重い処理は部分採用
- **ロールバック**：`tx_id` 単位のオール・オア・ナッシング + 適用前検証
- **コンフリクト**：基本 LWW、マスタ系はメイン優先
- **バッチ/再開**：1万行前後/COMMIT、`last_lsn` 更新で再開可能

## 3. セキュリティ・権限

- **認証**：アプリ内DBにユーザとハッシュ（パスワード）
- **RBAC**：ユーザに複数ロールを付与可能
- **監査**：タイムスタンプ・ユーザID・アクションを記録

## 4. パフォーマンス

- **インデックス**：集計用に適切に追加
- **年次分割**：SQLiteは年度ごとにDBファイル分割を推奨
- **大量出力**：CSVはキューセット + BufferedWriter（UTF-8 BOMオプション）
- **集計キャッシュ**：まずはアプリ内メモリ、必要ならDBキャッシュ

## 5. 運用・リリース

- **マイグレーション**：`schema_version` 管理、順序適用（Flyway風）。PRAGMA は WAL 等を強制。
- **サンプルデータ**：最小セット（Company1 / Store2 / Visitor14日 / Budget1件 / Users3）
- **環境分離**：`APP_ENV` 切替、`DB_PATH_*` 環境変数。prodは読み取り専用/更新分離
- **バックアップ**：日次フル + 週次フル保持。`VACUUM INTO` でホットコピー。

## 6. テスト

- **ユニット**：按分・前年リンク・権限
- **統合**：2DB同期、`tx_id` ロールバック、例外挿入
- **負荷**：目標 C1 < 1s / C4 < 3s（店舗600×365モデル）

## 7. GUI着手前の設計

- **API契約**：入力（company_id, store_id, yyyymm 等）、出力（items, totalCount, lastLsn, generatedAt）
- **ドリルダウン**：会社→ブランド→店舗→日→明細
- **ページング/スクロール**：行はキーセットページング、列は仮想スクロール

------

# Git運用方針（統一）

## ブランチ戦略（ trunk-based ）

- **main**：常にデプロイ/検証可能（保守ブランチ）
- **feat/**：機能追加の短命ブランチ（例：`feat/sync-push-cli`）
- **fix/**：バグ修正
- **release/**：必要時のみ

## コミット/PR

- **Conventional Commits**：`feat: … / fix: … / refactor: … / test: … / docs: …`
- **小さく頻繁にPR**。PRテンプレに「目的/設計要点/テスト観点」を必須欄にする。
- **必須チェック**：ビルド・テスト成功、既存CLI実行可能、性能退行なし

## タグ/リリース

- **タグ**：`v0.x.y`（初期は0系）
- **GitHub Releases**：バイナリはここに添付（CIで自動化）

------

# 推奨ディレクトリ構成（抜粋）

...（略。詳細はARCHITECTURE_AND_FOLDER.md を参照）


