# 業務用アプリ設計案（整理版 v1.3）

## 目的 / 非目的

- **目的**：店舗の来店客数（将来は売上も）を、会社横断で「日次／月次」で集計・比較し、権限管理のもとで閲覧・管理できる基盤を作る。
- **非目的（当面）**：高度な可視化・UI最適化、複雑なワークフロー、DWH規模の横断分析。

## MVPスコープ（GUIなし・コア先行）

1. **DB同期の骨組み**（メインDB⇄クライアントDB、LSN方式、Push/Pullと差分適用）
2. **マスタ最小セット**（会社・店舗・国/ブランド/立地・ユーザー/権限）
3. **日次データ登録**（来店客数：予算・実績・前年系）
4. **按分エンジン**（月次予算×係数→日別配賦、月合計は不変で日割だけ変動）
5. **レポートの計算API**（C1〜C4に必要な集計を返すサービス層まで）

> GUIは後付け（第2段階）。まずは上記5点の**CLI/サービスAPI**を完成させる。

## 技術スタック（確定）

- 言語/ランタイム：Java
- ビルド：Maven
- ストレージ：SQLite（メインDB/クライアントDB）
- 将来GUI：JavaFX（第2段階）
- 開発：VS Code + GitHub Copilot、Git運用

------

## アーキテクチャ（層とモジュール）

- **domain**：エンティティ（Company, Store, VisitDaily, BudgetDaily, Factors…）/ 値オブジェクト / ドメインサービス（按分）
- **application**：ユースケース（Sync、Import/Export、ReportQuery、UserProvisioning）
- **infrastructure**：SQLiteリポジトリ、マイグレーション、接続・トランザクション、LSN/ChangeLog
- **interface（CLI first）**：コマンド（例：`sync pull`, `sync push`, `report c1 --yyyymm=202501 --company=JP`）

> 第2段階で **ui-javafx** モジュールを追加し、application層のユースケースを呼び出す。

------

## データ設計（骨子）

### マスタ

- **Company**（会社）
- **Country / Brand / LocationType**（所在国・ブランド・立地種別）
- **Store**（会社FK・コード・名称・国・ブランド・立地・席数・営業時間・ステータス・ブロック・エリア等）
- **User / Role / UserRole**（ログインと権限）
- **CodeMaster**（将来の汎用コード表は後回しOK）

### 取引・明細

- **VisitDaily**：店舗×日付の実績値（来店客数）
- **BudgetMonthly**：店舗×年月の月次予算
- **BudgetFactors**：店舗（または会社共通）×年月の係数セット（按分用）
- **VisitDailyPrev**：前年同日／前年同曜日の参照値（計算 or 参照テーブル）

### 同期・監査

- **change_log**（グローバルLSN、DML、対象テーブル、主キー、差分、tx_id、tombstone等）
- **sync_state**（クライアントごとの最終適用LSN）
- **id_map**（必要なら：クライアント暫定ID→メインID）
- **sync_lock**（排他）

> **BudgetDaily（派生）\**は当面\**持たず**、**オンデマンド計算**または**キャッシュ**で対応。

------

## 同期方式（LSN/ChangeLogの要点）

- **決定**：**Main/Client ともに実テーブル＋change_log を保持**（ログ専用メインは採用しない）。
- 変更は**各実テーブルのトリガー**で `change_log` に記録（I/U/D + tombstone）。
- **Push/Pull**は `sync_state.last_lsn` より新しい差分を**バッチ適用**。
- **競合**：基本は**メイン最優先**。クライアントは**push前にpull**で整合を確保。
- **主キー衝突**：PKは原則 `INTEGER`（ROWID）。マスタは**業務キーUNIQUE**（例：`store_code`）で同一判定・マージ。必要時のみ `id_map`（暫定ID→正規ID）を使用。
- **パフォーマンス**：バルク、ATTACH、適切なインデックス（PK/FK/検索キー）、PRAGMA最適化。
- **再開性**：バッチごとにCOMMIT→`last_lsn`更新。途中失敗時は**Idempotent UPSERT/DELETE**で再開。

------

## レポート（C1〜C4）実装方針（GUI前提の準備）

- **API化**：C1〜C4の**集計クエリ/サービス**を先に提供し、GUIは後で呼び出すだけ。
- **前年同日/同曜日切替**：日付ディメンション（暦テーブル）or 計算ロジックで吸収。
- **大規模表示**：
  - **ページング／仮想スクロール**（C1/C4は特に）
  - **サマリ→ドリルダウン**段階読み出し
  - **事前集計/マテビュー**は将来オプション
- **小計の単位**：
  - 日本：会社→ステータス→ブロック→エリア→店舗（深め）
  - 海外：会社→ステータス→店舗（浅め）
  - 会社別の**既定ドリル順**は設定で切替可能に

------

# これから決める＆検討すべき点（一覧）

## 1. データ・仕様

- **日付ディメンション**：持つ（祝日/曜日/会計月/前年リンクを保持）。
- **前年参照**：日付ディメンション内に前年参照を保持。
- **按分（合計固定）**：月合計固定、係数変更で日割比率のみ変動。
- **端数処理**：**最大剰余法（Hamilton法）**。
- **会社共通係数と個別**：**店舗個別が優先**。
- **店舗ステータス遷移**：
  - 新店：未出店 → 当期新店 → 前期新店 → 既存店
  - 閉鎖：当期閉鎖予定 → 当期閉鎖 → 前期閉鎖 → 過去閉鎖
  - 改装：当期改装予定 → 当期改装 → 前期改装 → 通常へ復帰
- **OPEN/CLOSE月**：月単位扱い（日割りしない）。
- **タイムゾーン/営業日**：深夜0時切替（跨ぎ営業なし前提）。
- **売上導入**：MVPから導入（来店客数と同スキーマ枠組み）。

## 2. 同期・オフライン

- **差分粒度**：行単位（将来、列差分へ拡張可）。
- **ATTACH**：重い処理は部分採用。
- **ロールバック**：`tx_id` 単位のオール・オア・ナッシング＋適用前検証。
- **コンフリクト**：基本 **LWW**、マスタ系は**メイン優先**。
- **バッチ/再開**：1万行前後/COMMIT、`last_lsn` 更新で再開。

## 3. セキュリティ・権限

- **認証**：アプリ内DBにユーザー＋ハッシュパスワード。
- **RBAC**：ユーザーに複数ロール付与可。
- **監査**：時刻・ユーザーID・アクション・対象・結果を記録。

## 4. パフォーマンス

- **インデックス**：主要クエリ確定後に最適化。
- **年次分割**：SQLiteは**年度ごとにDBファイル分割**。
- **大量出力**：CSVはキーセット＋BufferedWriter（UTF-8 with BOM、RFC 4180）。Excelは必要時のみSXSSF、100万行超はCSV推奨。
- **集計キャッシュ**：まずはアプリ内メモリ、必要に応じDBキャッシュ表へ。失効は LSN/TTL/手動。

## 5. 運用・リリース

- **マイグレーション**：`schema_version` 管理、昇順適用（Flyway風）。PRAGMAはWAL等を強制。
- **サンプルデータ**：最小セット（Company1・Store2・Visitor14日・Budget1件・Users3）。
- **環境分離**：`APP_ENV` 切替、`DB_PATH_*` 環境変数。prodはRO/Update分離。
- **バックアップ**：日次フル＋週次フル保持。`VACUUM INTO`でホットコピー、週1でリストア検証。

## 6. テスト

- **ユニット**：按分・前年リンク・権限。
- **統合**：2DB同期、`tx_id` ロールバック、例外注入。
- **負荷**：目標応答 C1 < 1s / C4 < 3s（店舗600×365規模）。
- **リグレッション**：マイグレーション前後で差分比較をCI自動化。

## 7. GUI着手前の設計

- **API契約**：入力（company_id, store_id, yyyymm等）、返却（items, totalCount, lastLsn, generatedAt）。DTO→JSON。
- **ドリルダウン**：会社→ブランド→店舗→日→明細。設定で段階上書き可。
- **ページング/スクロール**：行は**キーセットページング**、列は**仮想スクロール**。返却に `nextCursor`。

------

# Git 運用方針（統一）

## ブランチ戦略（トランクベース）

- **main**：常にデプロイ／検証可能（保護ブランチ）。
- **feat/***：機能追加の短命ブランチ（例：`feat/sync-push-cli`）
- **fix/***：バグ修正（例：`fix/lsn-retry`）
- **release/***（必要時のみ）：タグ調整用

## コミット/PR

- **Conventional Commits**：`feat: … / fix: … / refactor: … / test: … / docs: …`
- **小さく頻繁にPR**。PRテンプレに「目的／設計要点／テスト観点」を固定欄で。
- **必須チェック**：ビルド・テスト成功、既存CLI実行可能、性能退行なし。

## タグ/リリース

- **タグ**：`v0.x.y`（初期は0系）。
- **GitHub Releases**：**バイナリはここにのみ**。ZIP/JARやサンプルDBを添付。CIで自動化。

## バイナリ・大容量の扱い

- `/.gitignore`：`*.db`, `/dist/**`, `*.zip`, `*.jar` など除外。
- LFSは原則不使用（要件が出たら検討）。

## DBとバージョン

- アプリSemVerと**スキーマ版**を連動（`schema_version`テーブル）。
- 破壊的DDLは**必ずマイグレーション**で（手作業禁止）。

## CI（最小）

- push/PR：`mvn -DskipTests=false test`（＋静的解析は任意）
- タグ：ビルド→ZIP作成→Releases へアップロード

------

# 推奨ディレクトリ & パッケージ（例）

- ディレクトリの構造案

```
<repo-root>/
├─ README.md
├─ LICENSE
├─ pom.xml                         # まずは単一モジュール（将来 parent に昇格）
├─ .gitignore                      # *.db / dist/** / *.zip / *.jar などを除外
├─ .gitattributes                  # 改行コード/テキスト正規化
├─ .editorconfig                   # インデント/文字コードの統一
├─ .github/
│  ├─ PULL_REQUEST_TEMPLATE.md
│  └─ workflows/
│     └─ ci.yml                    # mvn test / タグ時にZIPをReleases
├─ docs/
│  ├─ ARCHITECTURE_AND_FOLDER.md   # 層構造/命名規約（この構成を反映）
│  ├─ DB_RULES_SQLITE.md           # PRAGMA/WAL/DDL規約/命名
│  ├─ DB_SYNC_POLICY.md            # LSN/ChangeLog/tx_id/再開ポリシー
│  ├─ TEST_POLICY.md               # ユニット/統合/負荷/回帰
│  └─ PROJECT_RULES.md             # コーディング規約/サイズ制約/ブランチ運用
├─ config/
│  ├─ app.dev.env                  # APP_ENV=dev / DB_PATH_* など
│  ├─ app.stg.env
│  └─ app.prd.env
├─ scripts/
│  ├─ run-cli.sh                   # java -jar app-core/target/app-core.jar "$@"
│  ├─ run-cli.bat
│  ├─ migrate.sh                   # 初期DDL/マイグレーション適用
│  ├─ seed.sh                      # サンプルデータ投入
│  └─ package-release.ps1          # ZIP作成（Releases 添付向け）
├─ db/
│  ├─ migrations/
│  │  ├─ 001_init.sql              # company/store/... + change_log/sync_state 等
│  │  ├─ 002_add_unique_keys.sql   # 業務キー UNIQUE / 冪等キー UNIQUE
│  │  └─ 003_triggers_changelog.sql# I/U/D トリガ + tombstone
│  ├─ seeds/
│  │  ├─ companies.sql
│  │  ├─ stores.sql
│  │  └─ sample_visits_and_budget.sql
│  └─ sample/                      # サンプルDBを置くフォルダ（.gitignore 対象）
│     └─ README.md                 # 置き方と注意（コミット禁止）
└─ app-core/
   ├─ pom.xml
   ├─ src/
   │  ├─ main/
   │  │  ├─ java/
   │  │  │  └─ com/kenfukuda/dashboard/
   │  │  │     ├─ domain/
   │  │  │     │  ├─ model/
   │  │  │     │  │  ├─ Company.java
   │  │  │     │  │  ├─ Store.java
   │  │  │     │  │  ├─ VisitDaily.java
   │  │  │     │  │  ├─ BudgetMonthly.java
   │  │  │     │  │  ├─ BudgetFactors.java
   │  │  │     │  │  └─ enums/{StoreStatus.java,LocationType.java,...}
   │  │  │     │  └─ service/
   │  │  │     │     └─ ApportionService.java         # 月→日 按分（Hamilton法）
   │  │  │     ├─ application/
   │  │  │     │  ├─ dto/
   │  │  │     │  │  ├─ report/{C1Request.java,C1Row.java,...}
   │  │  │     │  │  └─ sync/{PullRequest.java,PushRequest.java}
   │  │  │     │  ├─ usecase/
   │  │  │     │  │  ├─ SyncService.java              # push/pull（last_lsn再開）
   │  │  │     │  │  ├─ ReportQueryService.java       # C1〜C4 集計API
   │  │  │     │  │  ├─ SeedService.java              # サンプル投入
   │  │  │     │  │  └─ MigrationService.java         # マイグレーション実行
   │  │  │     │  └─ util/
   │  │  │     │     └─ Pagination.java               # キーセットページング
   │  │  │     ├─ infrastructure/
   │  │  │     │  ├─ db/
   │  │  │     │  │  ├─ SqliteConnectionManager.java
   │  │  │     │  │  ├─ SqlitePragmaConfigurer.java   # WAL/同期/キャッシュ設定
   │  │  │     │  │  ├─ MigrationRunner.java          # /db/migrations/*.sql 実行
   │  │  │     │  │  └─ Tx.java                       # try-with-resources でTX管理
   │  │  │     │  ├─ repository/
   │  │  │     │  │  ├─ CompanyRepository.java
   │  │  │     │  │  ├─ StoreRepository.java
   │  │  │     │  │  ├─ VisitDailyRepository.java
   │  │  │     │  │  ├─ BudgetMonthlyRepository.java
   │  │  │     │  │  ├─ BudgetFactorsRepository.java
   │  │  │     │  │  ├─ ChangeLogRepository.java      # change_log 読み書き
   │  │  │     │  │  └─ SyncStateRepository.java
   │  │  │     │  └─ mapper/
   │  │  │     │     └─ RowMapperHelpers.java
   │  │  │     └─ cli/
   │  │  │        ├─ Main.java                        # エントリポイント（picocli等）
   │  │  │        ├─ commands/
   │  │  │        │  ├─ SyncPullCommand.java          # sync pull --target=client.db
   │  │  │        │  ├─ SyncPushCommand.java          # sync push --source=client.db
   │  │  │        │  ├─ ReportC1Command.java          # report c1 --yyyymm=202501 ...
   │  │  │        │  ├─ MigrateCommand.java           # db migrate
   │  │  │        │  └─ SeedCommand.java              # db seed
   │  │  └─ resources/
   │  │     ├─ application.properties                 # DB_PATH_* / APP_ENV 等
   │  │     ├─ sql/                                   # 複雑SELECTやビューの定義
   │  │     │  ├─ report/                             # C1〜C4用のSQL断片
   │  │     │  └─ sync/                               # 差分取得/適用のSQL断片
   │  │     └─ logback.xml                            # ログ設定（任意）
   │  └─ test/
   │     └─ java/
   │        └─ com/kenfukuda/dashboard/
   │           ├─ domain/service/ApportionServiceTest.java
   │           ├─ application/usecase/SyncServiceIT.java   # IT: in-memory SQLite
   │           └─ application/usecase/ReportQueryServiceIT.java
└─ app-ui-javafx/                  # ← 後で追加（今は空または存在しない）
   ├─ pom.xml
   └─ src/
      ├─ main/java/com/kenfukuda/dashboard/ui/
      │  ├─ App.java                         # JavaFX Application
      │  ├─ controller/                      # 画面ごと Controller
      │  └─ viewmodel/                       # DTO/双方向バインド
      └─ main/resources/
         ├─ fxml/{Main.fxml,ReportC1.fxml,...}
         └─ css/app.css

```

- 上記の構成は必要に応じて変更してかまわないが、極力この構成を維持するように努めること

> ルート直下は最小限（README、LICENSE、pom.xml等）。テストは `src/test/java`。

------

# 最初のマイルストーン（GUIなし）

**M1：スケルトン + マイグレーション + サンプルデータ**
 Maven雛形／接続クラス／DDLマイグレーション／Seed投入コマンド

**M2：LSN同期の最小実装**
 `change_log`トリガー・`sync_state`・push/pull CLI・`last_lsn`再開・簡易競合

**M3：按分エンジン + 日次API**
 月次→日次配賦（端数含む）・会社共通→店舗個別の優先順位・ユニットテスト

**M4：レポート計算API**
 C1〜C4集計ユースケース（DTO/ページング）・CSV出力

**M5：（第2段）GUI着手**
 JavaFXはAPI呼び出しのみで構築（ビジネスロジックは触らない）