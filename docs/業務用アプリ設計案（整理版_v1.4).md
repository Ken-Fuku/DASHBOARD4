# 業務用アプリ設計案（整理版 v1.4）

以下は元の設計案（v1.3）に対して、M1 実装に際して優先的に検討・補強すべき点を追記したバージョンです。M1 を開始するために必要な決定事項と注意点を明確化しています。

## 目的 / 非目的

- **目的**：店舗の来店客数（将来は売上も）を、会社横断で「日次／月次」で集計・比較し、権限管理のもとで閲覧・管理できる基盤を作る。
- **非目的（当面）**：高度な可視化・UI最適化、複雑なワークフロー、DWH規模の横断分析。

## 変更履歴

- v1.0: 初版
- v1.3: 主要設計案（MVP / 同期 / 按分 等）
- v1.4: v1.3 に対する M1 実装で優先的に必要な補強点を追記（本ドキュメント）

## 要約（結論）

現行の v1.3 から致命的な欠落はなく、M1（スケルトン + マイグレーション + サンプルデータ）に進めて問題ありません。ただし、M1 で以下の点を設計決定・実装しておくことを強く推奨します。

1. SQLite のトランザクション/PRAGMA 設定を明確化して MigrationRunner 起動時に適用する
2. change_log スキーマの必須カラムを明記し、マイグレーションに含める
3. 認証のハッシュ方式（PBKDF2/BCrypt/Argon2）を選定して実装する
4. Push/Pull の伝送経路（ファイル受け渡し or REST over TLS）を明確化する
5. マイグレーションは冪等であり、MigrationRunner での失敗時ロールバックを確実にする

以下に元設計の要点と、v1.4 で追加・補強した項目を示します。

---

## 元設計の主なポイント（抜粋）

- 言語/ビルド: Java / Maven
- DB: SQLite（Main / Client 共に）
- 同期: LSN + change_log、トリガでログ記録、Push/Pull バッチ適用
- 按分: 月合計固定、日割りは係数で配分（端数は Hamilton 法）
- 層構造: domain / application / infrastructure / interface（CLI first）
- M1: スケルトン、マイグレーション、サンプルデータ

---

## M1: 実装時に決めるべき優先事項（追記）

### 1) SQLite トランザクションと PRAGMA 設定

- M1 で `SqlitePragmaConfigurer` を実装し、以下 PRAGMA を MigrationRunner 起動時または `SqliteConnectionManager` で適用すること。
  - `PRAGMA journal_mode = WAL;`
  - `PRAGMA synchronous = NORMAL;`（必要に応じ `FULL` を検討）
  - `PRAGMA foreign_keys = ON;`
  - `PRAGMA temp_store = MEMORY;`
- 理由: WAL は読み取り並列性を改善し、オフライン同期での可用性向上に寄与する。Migration 時には WAL の有効化と `VACUUM INTO` を考慮。

### 2) change_log スキーマ（必須カラム）

change_log テーブルは以下を最低限持つことを明文化する（マイグレーションに含める）。

- `lsn` (INTEGER PRIMARY KEY AUTOINCREMENT) -- 全体順序付け
- `tx_id` (TEXT) -- UUID 等のトランザクション識別子
- `table_name` (TEXT) -- 変更対象テーブル
- `pk_json` (TEXT) -- 主キー値（単一 or JSON）
- `op` (TEXT) -- 'I' | 'U' | 'D'
- `payload` (TEXT) -- 変更後の行（JSON）または差分
- `tombstone` (INTEGER) -- 削除フラグ（1/0）
- `created_at` (TEXT) -- ISO8601 タイムスタンプ

- 補足: payload は将来列差分対応を考慮し JSON にしておくと柔軟。`pk_json` と組み合わせると idempotent な適用がしやすい。

### 3) 認証/パスワードハッシュ

- M1 でもユーザ作成/ハッシュ方式は必須。
- 推奨: BCrypt（簡便）または Argon2（より強力）。Java では `BCrypt` のライブラリ（Spring Security の BCryptPasswordEncoder または `de.mkammerer:argon2-jvm`）を採用可能。
- パスワードハッシュに関する設定は `application.properties` で管理し、将来は KMS と連携しやすくする。

### 4) 同期の伝送経路

MVP ではネットワークがない環境も想定されるため、以下を明記する。

- オフライン/単純: DB ファイルの受け渡し（`sqlite` ファイルを直接コピー）や ChangeLog をエクスポートしたファイルでのやり取り
- ネットワークあり: REST over TLS（Push/Pull 用のシンプル HTTP API）を推奨

M1 では「まずファイルベースの Push/Pull」（ChangeLog のエクスポート/インポート）を実装し、後段で TLS/HTTP を追加する方針が現実的。

### 5) マイグレーションの堅牢性

- マイグレーション SQL は冪等（IF NOT EXISTS / CREATE TABLE IF NOT EXISTS）で書く。
- `MigrationRunner` はトランザクション境界を守り、失敗時はロールバックする。可能ならマイグレーションの履歴（schema_version）に加えて SHA256 ハッシュを持たせて改ざん検出を容易にする。

---

## M1 の実装チェックリスト（具体）

- [ ] `docs/` に本ドキュメントを追加（本ファイル）
- [ ] `pom.xml`（ルート/`app-core`）の雛形を作成
- [ ] `MigrationRunner`：（`db/migrations/*.sql` を idempotent に適用）
- [ ] `db/migrations/001_init.sql`：`company`, `store`, `visit_daily`, `change_log`, `sync_state` 等の DDL（上記 change_log 定義を反映）
- [ ] `SqlitePragmaConfigurer`：WAL 等の PRAGMA を有効化
- [ ] `SeedService`：最小サンプルを投入する seed スクリプト/コマンド
- [ ] `cli/Main`：picocli 等で `migrate` / `seed` / `sync` の基本コマンドを実装
- [ ] `apportion`（按分）サービスのユニットテスト（簡易ケース）
- [ ] CI：`mvn test` を実行する GitHub Actions（`/.github/workflows/ci.yml`）

---

## 追加の実装推奨（M1 の範囲で簡単に着手できるもの）

- `ChangeLogRepository` に `applyChangeLogEntry` の idempotent 実装を置く。
- `SyncStateRepository` にクライアントごとの `last_lsn` を格納するテストユーティリティ。
- `scripts/migrate.ps1`（Windows 用）を追加して、PowerShell での初期化を簡単に。
- `docs/DB_SYNC_POLICY.md` を更新して、Push/Pull のファイルフォーマット（JSON lines 形式など）を定義する。

---

## テスト方針（M1）

- ユニット: 按分ロジック、日付ロジック、ユーティリティ
- 統合: MigrationRunner によるスキーマ適用→シード投入→簡易クエリ
- IT: in-memory ではなく「ファイルベースの SQLite」を用いたテスト（本番に近い）

---

## 運用とドキュメント

- `README.md` に「M1 の開始手順」「初期 DB の作成」「主要コマンド一覧」を明記する。
- `docs/DB_RULES_SQLITE.md` を整備して PRAGMA, WAL, VACUUM ポリシーを記載する。

---

## 次のステップ

1. 本ファイルを `docs/業務用アプリ設計案（整理版_v1.4).md` として保存（完了）
2. M1 のタスクをさらに細分化してチケット化（必要なら私が提案します）
3. `app-core` の Maven モジュール雛形を作成して、MigrationRunner と CLI の雛形を実装

---

作成済み: このドキュメントはプロジェクト `docs/` に保存済みです。
