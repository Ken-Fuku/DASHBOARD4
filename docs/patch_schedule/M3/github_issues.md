# GitHub Issues 原案 — M3: 按分エンジン + 日次API

以下はそのままコピー＆ペーストして GitHub Issue として使える原案です。ラベル／担当／見積りはプロジェクトに合わせて調整してください。

---

## Epic: M3: 按分エンジン + 日次API
labels: epic, M3
assignees: @（担当）
estimate: 10d

概要
- 月次データを日次に按分するエンジンと、日次配賦を取得する API を実装する。

受け入れ基準
- 会社共通→店舗個別の優先順位に従って分配されること
- 端数処理ルールに基づき合計が整合すること（例: 月合計 == 日次合計）
- 単体テストで主要ケースをカバーしていること
- 日次取得 API で所定のレスポンスが返ること

関連Issue
- RFC: 按分設計
- Implement: 按分エンジン
- API: 日次配賦取得
- Test: 単体テスト

---

## RFC: 按分ルール・端数処理設計
labels: design, spec
assignees: @（担当）
estimate: 1d

概要
- 配賦優先度設計（会社共通 → 店舗個別）と端数処理（丸めルール）を決定する。

チェックリスト
- [ ] 優先順位の定義（会社共通優先度の具体例）
- [ ] 端数処理ルール定義（切上/切捨/銀行丸め等）
- [ ] サンプルケース（例：月次100が29日/30日/31日に分配される例）
- [ ] accept criteria 文書化

受け入れ基準
- 設計ドキュメントがレビュー承認されること

---

## Implement: 按分エンジン（コア）
labels: backend, allocation
assignees: @（担当）
estimate: 3d

概要
- 月次金額を日次に按分するコアロジックを実装する。
- 会社共通配賦→店舗個別配賦の優先処理を含む。
- 端数処理は RFC に準拠。

API / 関数仕様（例）
- function distributeMonthlyToDaily(monthAmount, year, month, priorityRules) -> [{date, amount} ...]

チェックリスト
- [ ] 基本按分ロジック実装
- [ ] 優先度適用（会社共通→店舗個別）
- [ ] 端数処理の実装
- [ ] 単体テスト雛形作成

受け入れ基準
- RFC のケースを全てパスするユニットテストが存在すること

---

## API: 日次配賦取得エンドポイント
labels: api, backend
assignees: @（担当）
estimate: 2d

概要
- 日次配賦を取得する REST API を実装する。認可は既存の方式に準拠。
- エンドポイント例:
  - GET /api/v1/allocations/daily?year=YYYY&month=MM&storeId=xxx
  - GET /api/v1/allocations/daily?year=YYYY&month=MM (全店舗/会社共通)

レスポンス例
```
{
  "year": 2025,
  "month": 9,
  "daily": [
    {"date": "2025-09-01", "storeId": "S1", "amount": 123.45},
    ...
  ],
  "totalMonthly": 12345.67
}
```

チェックリスト
- [ ] エンドポイント実装
- [ ] パラメータバリデーション
- [ ] パフォーマンス確認（1ヶ月分の取得）
- [ ] エラーハンドリング

受け入れ基準
- 正しい日次配賦が返ること（サンプル確認）

---

## Test: 按分エンジン 単体テスト
labels: test, unit
assignees: @（担当）
estimate: 2d

概要
- 按分ロジックのユニットテストを実装する。端数・優先度・境界値を含む。

チェックリスト
- [ ] 正常系ケース（均等配分）
- [ ] 端数ケース（合計整合）
- [ ] 優先度ケース（会社共通→店舗個別）
- [ ] 異常系入力（0金額、負値、日数異常）

受け入れ基準
- CI で全テストが通ること

---

## Integration & QA: 日次配賦 結合確認
labels: qa, integration
assignees: @（担当）
estimate: 1d

概要
- エンジン＋APIをステージ環境で結合し、実データで確認する。

チェックリスト
- [ ] ステージ環境デプロイ
- [ ] 実データでの整合確認（複数月）
- [ ] レスポンス形式・エッジケース確認
- [ ] バグ修正リスト作成

受け入れ基準
- 主要ケースの確認が完了し、致命的バグがないこと

---

## Docs: 実装仕様・変更点のドキュメント
labels: docs
assignees: @（担当）
estimate: 1d

概要
- 実装した按分ルール、API 仕様、サンプルリクエスト/レスポンスをドキュメント化する。

チェックリスト
- [ ] API spec 更新（OpenAPI/README）
- [ ] 按分ロジック説明（サンプル含む）
- [ ] リリースノート草案

受け入れ基準
- ドキュメントがレビュー承認されること

---

### 次のアクション（提案）
1. RFC を Issue として作成し、24 時間以内にレビューを依頼する
2. RFC 承認後に Implement Issue を割り当てて着手する

必要なら、各 Issue に合わせた具体的なコード雛形（配分関数・テストケース・API ハンドラ）を作成します。どれを先に出しますか？
