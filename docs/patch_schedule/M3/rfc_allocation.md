# RFC: 按分ルール・端数処理設計（M3: 按分エンジン + 日次API）

作成日: 2025-09-18
作成者: （担当未定）

## 目的
月次で登録された金額を日次に配賦するロジックを設計・合意する。端数処理と配賦優先順位（会社共通→店舗個別）を明確にし、実装の受け入れ基準とテストケースを定義する。

## 背景
現行データは月次単位で蓄積されているため、日次レベルのレポートや分析、日次請求等のために月次金額を日次に按分する必要がある。按分時の端数処理は合計整合性に影響するため、明確なルールが必要。

## 重要用語
- 会社共通: 全社で配賦される共通費用。店舗に均等または重み付きで分配される。
- 店舗個別: 個別店舗に紐づく費用。原則その店舗に割り当てられる。
- 優先度ルール: 会社共通配賦を先に適用し、残額を店舗個別へ割り当てる等の優先順。
- 端数処理: 小数点以下の扱い（切上/切捨/銀行丸め/按分での調整）

## 要求仕様（高レベル）
1. 月次金額（月合計）を、当該月の各営業日に比例または均等に分配できること。
2. 端数処理は「合計整合性」を最優先とし、実運用での再現性がある方法を選択する。
3. 配賦優先順位はデフォルトで「会社共通 → 店舗個別」とするが、ルールは設定で変更可能とする。
4. API は年・月・店舗でフィルタ可能であること（全店舗/会社共通含む）。

## 端数処理案（候補）
以下の候補を比較検討し、1つを採用する。運用上のわかりやすさと合計整合性を重視する。

A. 基本均等配分 + 最終日で調整
- 各日の金額 = floor(monthTotal / days * 100) / 100
- 端数（総和と月合計の差）は最終営業日に加算して合計を一致させる
- 長所: 実装が簡単、再現性あり
- 短所: 調整が特定日に集中する（最後の日）

B. 切捨/切上のローテーション（丸め補正分散）
- 各日で四捨五入等を適用し、誤差を日付順に1円単位で振り分ける
- 長所: 端数が特定日に偏らない
- 短所: 実装がやや複雑、再現性は高いがルールが複雑

C. 比率按分（連続値で保持） + 表示時に丸め
- 内部では高精度（小数）で保持し、API/表示時に丸め処理を行う
- 長所: 精度が高く、把握しやすい
- 短所: 表示上の合計ズレが発生する可能性（表示丸めの扱いを定義する必要あり）

推奨案（初期実装）: A（基本均等配分 + 最終日で調整）
理由: 実装コストが低く、合計整合性を簡単に保証できる。運用で問題が出た場合、BまたはCに移行する。

## 配賦優先順位（詳細）
1. 会社共通（global）: 月合計からまず会社共通分を算出し、日次へ配賦する
2. 店舗個別: 残りを各店舗に割り当てる（店舗ごとの比率や日次の営業日数で調整）

優先度ルールの例
- 会社共通金額を先に日次均等分配
- 店舗個別はそれぞれの月合計を店舗の日数で均等分配
- 会社共通を店舗に割り当てる優先度（例えば、会社共通を店舗比率で再配分する等）は設定で制御可能とする

## API 入出力仕様（草案）
- GET /api/v1/allocations/daily?year=YYYY&month=MM[&storeId=xxx]
  - Response 200
  {
    "year": 2025,
    "month": 9,
    "daily": [
      {"date": "2025-09-01", "storeId": "S1", "amount": 123.45},
      ...
    ],
    "totalMonthly": 12345.67
  }

- パラメータ
  - year: 必須
  - month: 必須
  - storeId: 任意。未指定時は全店舗・会社共通を含む

- エラー
  - 400: パラメータ不正
  - 404: データ無し
  - 500: サーバエラー

## サンプル計算（例）
例: 月合計 = 100.00、対象日数 = 30
- 日次基本額 = floor(100.00 / 30 * 100) / 100 = floor(3.3333.. * 100) / 100 = 3.33
- 30 日分合計 = 3.33 * 30 = 99.90
- 端数= 0.10 → 最終日（30日目）に +0.10 して 3.43 とする

店舗個別の例: 店舗 A 月合計 60、店舗 B 月合計 40、両店とも 30 日稼働
- 店舗 A: 日次基本 2.00
- 店舗 B: 日次基本 1.33 → 1.33 * 30 = 39.90 → 最終日に +0.10 で 1.43

## テストケース（受け入れテスト）
1. 均等分配（非端数）
- 入力: 90.00、30日 → 各日 3.00
- 期待: 3.00 が 30 日分で合計 90.00

2. 端数発生（小数）
- 入力: 100.00、30日 → 各日 3.33、最終日に +0.10
- 期待: 合計 100.00、最終日に調整があること

3. 優先度適用
- 会社共通 10、店舗 A 50、店舗 B 40、30日稼働
- 期待: 会社共通が日次に先に配賦され、各店舗の合計に正しく反映されること

4. 異常系
- 入力: 0 金額 → 全て 0
- 負値金額 → 400 エラー
- 存在しない年月 → 404

## 実装ノート
- 内部計算は整数（セント）で扱う（例: 円なら 1 円 = 100 セント）して丸め誤差を回避する。
- 端数調整は日付のソート順に対して最後の有効日へ適用する。
- 設定で「丸め方式」を切り替えられるように実装（初期は "last-day-adjustment"）。

## 受け入れ基準
- RFC に含まれるサンプルケースが全てユニットテストでパスすること
- API が年・月（および任意の storeId）で正しいレスポンスを返すこと
- 月合計と日次合計が一致すること

## 次のステップ
1. ドキュメントレビュー（Issue/PR を作成してアサイン）
2. RFC 承認後、Implement Issue を作成し実装を開始
3. 実装後、ユニットテストと結合テストで検証

---

*追記*: 本 RFC では初期実装として簡潔さと合計整合性を重視し、端数の最終日調整方式（A）を採用する。運用上の要望が上がった場合は B/C 案の検討へ移行する。